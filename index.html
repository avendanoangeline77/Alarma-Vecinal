<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Base de Monitoreo Alarma Vecinal</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
/* Estilos principales */
body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    height: 100vh; 
    margin: 0; 
    background-color: #f0f2f5; 
    text-align: center; 
}
.container { 
    background: white; 
    padding: 2.5rem 4rem; 
    border-radius: 12px; 
    box-shadow: 0 6px 20px rgba(0,0,0,0.15); 
    min-width: 450px; 
    transition: all 0.5s ease-in-out;
}
h1 { 
    color: #1c1e21; 
    margin-bottom: 0.5rem; 
    font-size: 2.5rem;
}
#status { 
    font-weight: bold; 
    min-height: 24px; 
    margin-bottom: 1.5rem; 
    padding: 0.5rem;
    border-radius: 6px;
    background-color: #e9ecef;
}
/* Alerta Principal */
#alerta-display {
    font-size: 1.8rem;
    font-weight: 700;
    padding: 1.5rem;
    margin-top: 1rem;
    border-radius: 8px;
    background-color: #97917b; /* Color de fondo (Normal) */
    color: #140d0d; /* Texto (Normal) */
    border: 3px solid #9d9373;
    min-height: 100px; 
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

/* Estado de ALERTA ACTIVA (visual) */
.alerta-activa {
    background-color: #f8d7da !important; /* Rojo claro para alerta */
    color: #721c24 !important; /* Rojo oscuro para texto */
    border-color: #f5c6cb !important;
    animation: pulse-red 1s infinite alternate; /* Animaci贸n de parpadeo */
}

@keyframes pulse-red {
    from { box-shadow: 0 0 10px rgba(160, 25, 25, 0.9); }
    to { box-shadow: 0 0 20px rgba(185, 10, 10, 0.8); }
}

</style>
</head>
<body>

<div class="container">
    <h1>Base de Monitoreo Central</h1>
    <p id="status">Conectando al Broker MQTT...</p>

    <div id="alerta-display">
        Esperando Alerta de Vecino...
    </div>
    
</div>

<script>
const statusElement = document.getElementById('status');
const alertaDisplay = document.getElementById('alerta-display');

// --- Configuraci贸n MQTT ---
const brokerUrl = 'ws://10.56.13.32:9001'; 
const topicAlarma = 'alarma/estado'; 
const ALERTA_DURACION_MS = 2000; // 2000 milisegundos = 2 segundos

const client = mqtt.connect(brokerUrl);

// --- Eventos MQTT ---

client.on('connect', function () {
    statusElement.textContent = 'Conectado al Broker: ' + brokerUrl;
    statusElement.style.color = '#28a745';
    // Suscripci贸n al topic
    client.subscribe(topicAlarma, { qos: 1 }, function (err) {
        if (err) {
            console.error("Error al suscribirse:", err);
            statusElement.textContent = 'Error al suscribirse al topic.';
        } else {
            console.log(`Suscrito exitosamente a "${topicAlarma}"`);
        }
    });
});

client.on('message', function (receivedTopic, message) {
    const payload = message.toString();
    console.log(`Mensaje recibido en ${receivedTopic}: ${payload}`);

    if (receivedTopic === topicAlarma) {
        // --- L贸gica de la Alerta Temporal ---
        if (payload === 'ACTIVADO') {
            // 1. Mostrar la alerta de forma inmediata
            alertaDisplay.textContent = ' 隆ALERTA DE VECINO RECIBIDA! (Temporal)';
            alertaDisplay.classList.add('alerta-activa');
            
            // 2. Establecer el temporizador para restablecer el estado despu茅s de 2 segundos
            setTimeout(() => {
                // Solo si no hay otro estado activo (como ALARMA_BASE_SONANDO), volvemos a 'Esperando'
                if (alertaDisplay.textContent === ' 隆ALERTA DE VECINO RECIBIDA! (Temporal)') {
                    alertaDisplay.textContent = 'Esperando Alerta de Vecino...';
                    alertaDisplay.classList.remove('alerta-activa');
                }
            }, ALERTA_DURACION_MS); // 2000 ms
        } 
        // --- L贸gica de la Alarma de Base (Mantenida por el Broker) ---
        else if (payload === 'ALARMA_BASE_SONANDO') {
             alertaDisplay.textContent = ' 隆ALARMA SONORA DE BASE ACTIVA! (Sonando por 15 segundos)';
             alertaDisplay.classList.add('alerta-activa');
        }
        else if (payload === 'ALARMA_BASE_APAGADA' || payload === 'NORMAL') {
             alertaDisplay.textContent = 'LISTO. Esperando nuevas alertas.';
             alertaDisplay.classList.remove('alerta-activa');
        }
    }
});

// --- Manejo de Desconexi贸n y Errores ---
client.on('close', function() {
    statusElement.textContent = 'Desconectado. Reintentando...';
    statusElement.style.color = '#dc3545';
});

client.on('error', function (error) {
    console.error('Error de conexi贸n:', error);
    statusElement.textContent = 'ERROR de Conexi贸n: ' + error.message;
    statusElement.style.color = '#dc3545';
});

</script>

</body>
</html>